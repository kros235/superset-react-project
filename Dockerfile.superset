# Dockerfile.superset
FROM apache/superset:latest

# Root ê¶Œí•œìœ¼ë¡œ ì‹œìŠ¤í…œ íŒ¨í‚¤ì§€ ì„¤ì¹˜
USER root

# ì‹œìŠ¤í…œ íŒ¨í‚¤ì§€ ì—…ë°ì´íŠ¸ ë° MySQL ê´€ë ¨ íŒ¨í‚¤ì§€ ì„¤ì¹˜
RUN apt-get update && \
    apt-get install -y \
    default-mysql-client \
    default-libmysqlclient-dev \
    build-essential \
    pkg-config \
    python3-dev \
    curl \
    && rm -rf /var/lib/apt/lists/*

# pip ì—…ê·¸ë ˆì´ë“œ (root ê¶Œí•œìœ¼ë¡œ)
RUN pip install --upgrade pip

# ğŸ”¥ MySQL ë“œë¼ì´ë²„ë“¤ ë° CORS ì§€ì› íŒ¨í‚¤ì§€ ì„¤ì¹˜
RUN pip install --no-cache-dir PyMySQL==1.1.1
RUN pip install --no-cache-dir mysql-connector-python
RUN pip install --no-cache-dir flask-cors
RUN pip install --no-cache-dir gunicorn

# mysqlclient ì„¤ì¹˜ ì‹œë„ (ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰)
RUN pip install --no-cache-dir mysqlclient || echo "mysqlclient installation failed, continuing with PyMySQL only"

# ì„¤ì¹˜ëœ íŒ¨í‚¤ì§€ í™•ì¸
RUN pip list | grep -i mysql
RUN python -c "import pymysql; print('PyMySQL: OK')" || echo "PyMySQL: Failed"
RUN python -c "import mysql.connector; print('MySQL Connector: OK')" || echo "MySQL Connector: Failed"
RUN python -c "import flask_cors; print('Flask-CORS: OK')" || echo "Flask-CORS: Failed"

# ğŸ”¥ ì´ˆê¸°í™” ìŠ¤í¬ë¦½íŠ¸ ê°œì„  (CORS ë¬¸ì œ í•´ê²° í¬í•¨)
RUN echo '#!/bin/bash' > /app/superset-init.sh && \
    echo 'set -e' >> /app/superset-init.sh && \
    echo 'echo "=== Superset ì´ˆê¸°í™” ì‹œì‘ ==="' >> /app/superset-init.sh && \
    echo '' >> /app/superset-init.sh && \
    echo '# MariaDB ì—°ê²° ëŒ€ê¸°' >> /app/superset-init.sh && \
    echo 'echo "MariaDB ì—°ê²° ëŒ€ê¸° ì¤‘..."' >> /app/superset-init.sh && \
    echo 'while ! mysqladmin ping -h mariadb -u superset -psuperset123 --silent; do' >> /app/superset-init.sh && \
    echo '    echo "MariaDB ì—°ê²° ëŒ€ê¸°..."' >> /app/superset-init.sh && \
    echo '    sleep 3' >> /app/superset-init.sh && \
    echo 'done' >> /app/superset-init.sh && \
    echo 'echo "âœ… MariaDB ì—°ê²° ì„±ê³µ"' >> /app/superset-init.sh && \
    echo '' >> /app/superset-init.sh && \
    echo '# Superset ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™”' >> /app/superset-init.sh && \
    echo 'echo "ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ ì—…ê·¸ë ˆì´ë“œ ì¤‘..."' >> /app/superset-init.sh && \
    echo 'superset db upgrade' >> /app/superset-init.sh && \
    echo '' >> /app/superset-init.sh && \
    echo '# ê´€ë¦¬ì ê³„ì • ìƒì„±' >> /app/superset-init.sh && \
    echo 'echo "ê´€ë¦¬ì ê³„ì • ìƒì„± ì¤‘..."' >> /app/superset-init.sh && \
    echo 'superset fab create-admin \' >> /app/superset-init.sh && \
    echo '    --username admin \' >> /app/superset-init.sh && \
    echo '    --firstname Admin \' >> /app/superset-init.sh && \
    echo '    --lastname User \' >> /app/superset-init.sh && \
    echo '    --email admin@admin.com \' >> /app/superset-init.sh && \
    echo '    --password admin || echo "ê´€ë¦¬ì ê³„ì •ì´ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤"' >> /app/superset-init.sh && \
    echo '' >> /app/superset-init.sh && \
    echo '# Superset ì´ˆê¸°í™”' >> /app/superset-init.sh && \
    echo 'echo "Superset ê¸°ë³¸ ì„¤ì • ì´ˆê¸°í™” ì¤‘..."' >> /app/superset-init.sh && \
    echo 'superset init' >> /app/superset-init.sh && \
    echo '' >> /app/superset-init.sh && \
    echo 'echo "=== ì´ˆê¸°í™” ì™„ë£Œ ==="' >> /app/superset-init.sh && \
    echo 'echo "ğŸš€ Superset ì„œë²„ ì‹œì‘ ì¤‘..."' >> /app/superset-init.sh && \
    echo 'echo "ğŸ“ ì ‘ì† ì£¼ì†Œ: http://localhost:8088"' >> /app/superset-init.sh && \
    echo 'echo "ğŸ‘¤ ê´€ë¦¬ì ê³„ì •: admin / admin"' >> /app/superset-init.sh && \
    echo '' >> /app/superset-init.sh && \
    echo '# ğŸ”¥ Gunicornìœ¼ë¡œ ì„œë²„ ì‹œì‘ (ê°œë°œ í™˜ê²½ ì„¤ì •)' >> /app/superset-init.sh && \
    echo 'exec gunicorn \' >> /app/superset-init.sh && \
    echo '    --bind 0.0.0.0:8088 \' >> /app/superset-init.sh && \
    echo '    --workers 4 \' >> /app/superset-init.sh && \
    echo '    --worker-class gthread \' >> /app/superset-init.sh && \
    echo '    --threads 2 \' >> /app/superset-init.sh && \
    echo '    --timeout 120 \' >> /app/superset-init.sh && \
    echo '    --keep-alive 2 \' >> /app/superset-init.sh && \
    echo '    --max-requests 1000 \' >> /app/superset-init.sh && \
    echo '    --max-requests-jitter 100 \' >> /app/superset-init.sh && \
    echo '    --log-level debug \' >> /app/superset-init.sh && \
    echo '    --access-logfile - \' >> /app/superset-init.sh && \
    echo '    --error-logfile - \' >> /app/superset-init.sh && \
    echo '    "superset.app:create_app()"' >> /app/superset-init.sh

# ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
RUN chmod +x /app/superset-init.sh

# ğŸ”¥ í™˜ê²½ ë³€ìˆ˜ ì„¤ì • íŒŒì¼ ìƒì„±
RUN echo '# Superset í™˜ê²½ ë³€ìˆ˜' > /app/.env && \
    echo 'FLASK_APP=superset' >> /app/.env && \
    echo 'FLASK_ENV=development' >> /app/.env && \
    echo 'SUPERSET_CONFIG_PATH=/app/superset_config.py' >> /app/.env && \
    echo 'PYTHONPATH=/app:$PYTHONPATH' >> /app/.env

# superset ì‚¬ìš©ìë¡œ ì „í™˜
USER superset

# ì‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì •
WORKDIR /app

# í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
ENV PYTHONPATH="/app:$PYTHONPATH"
ENV FLASK_APP="superset"
ENV FLASK_ENV="development"

# ğŸ”¥ í¬íŠ¸ ë…¸ì¶œ
EXPOSE 8088

# ğŸ”¥ í—¬ìŠ¤ì²´í¬ ê°œì„ 
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:8088/health || exit 1

# ğŸ”¥ ì‹œì‘ ëª…ë ¹ ì„¤ì •
CMD ["/app/superset-init.sh"]